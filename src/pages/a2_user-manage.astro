---
// --- IMPORTS ---
import plmLogo from "../assets/PLMLogo.webp";
import "../styles/global.css";
import { Image } from "astro:assets";

// --- 1. TYPE DEFINITIONS ---
interface AdminProfile {
    name: string;
    role: string;
    adminId: string;
}

// --- 2. DATA FETCHING ---
async function fetchAdminProfile(): Promise<AdminProfile> {
    return {
        name: "DELA CRUZ, JUAN",
        role: "ADMIN",
        adminId: "ADMIN ID"
    };
}

const adminData = await fetchAdminProfile();
---

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLM Student Portal - Change Password</title>
    <link rel="icon" href={plmLogo.src} />
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-white font-sans min-h-screen flex flex-col text-gray-800">

    <!-- HEADER SECTION -->
    <header class="w-full bg-white shadow-sm z-50">
        <div class="flex justify-center py-4">
            <div class="w-15 h-15">
                 <Image src={plmLogo} alt="PLM Logo" class="w-full h-full object-contain" loading="eager" />
            </div>
        </div>
<div class="h-5 w-full bg-plm-navy border-b-9 border-[#991B1B]"></div>
        
        <nav class="border-y border-gray-200 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-around md:justify-center md:gap-4 text-sm font-medium text-gray-700">
                
                <!-- DROPDOWN: SYSTEM CONFIGURATION (Fixed Links) -->
                <div class="relative group">
                    <!-- Button style is 'Ghost'/Inactive because we are on User Management page -->
                    <button class="px-6 py-2 rounded hover:text-[#1e1e2f] hover:bg-gray-100 transition-all flex items-center gap-1 cursor-default text-gray-700">
                        System Configuration
                        <svg class="w-2.5 h-2.5 ml-1 fill-current opacity-50" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </button>
                    
                    <!-- Dropdown Panel -->
                    <div class="invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 absolute left-1/2 transform -translate-x-1/2 top-full mt-1 w-48 bg-[#EAEAEA] border border-gray-300 shadow-xl rounded-md z-50 overflow-hidden text-[#1e1e2f]">
                        <!-- FIX: Added '/system-configuration' before the query params -->
                        <a href="/a1_sysconfig-1?view=calendar" class="block px-4 py-3 text-center text-sm font-medium border-b border-gray-300/50 hover:bg-gray-200 transition-colors">
                            Calendar
                        </a>
                        <a href="/a1_sysconfig-1?view=course-creation" class="block px-4 py-3 text-center text-sm font-medium hover:bg-gray-200 transition-colors">
                            Course Creation
                        </a>
                    </div>
                </div>
                
                <!-- ACTIVE LINK -->
                <a href="/user-management" class="bg-[#1e1e2f] text-white px-6 py-2 rounded shadow-sm hover:bg-[#2d2d46] transition-all">
                    User Management
                </a>
                
                <a href="/a3_grade-audit" class="px-6 py-2 rounded hover:text-[#1e1e2f] hover:bg-gray-100 transition-all">Grade Audit</a>
                <a href="/a4_change-password" class="px-6 py-2 rounded hover:text-[#1e1e2f] hover:bg-gray-100 transition-all">Change Password</a>
            </div>
        </nav>

        <div class="bg-white border-b border-plm-gold/50 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
                <span class="text-gray-800">
                    Signed in as: <span class="font-bold uppercase">{adminData.name} ({adminData.adminId})</span>
                </span>
                <button class="text-[#991B1B] font-bold hover:underline text-xs tracking-wide">SIGN OUT</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow w-full max-w-4xl mx-auto p-6 md:p-8 relative">
        
        <h1 class="text-center text-2xl font-bold text-[#1e1e2f] mb-8 uppercase tracking-wide">MANAGE USER (Account Creation)</h1>

        <form id="user-form" class="space-y-6" onsubmit="return false;">

            <!-- 1. RECORDS PANEL -->
            <div class="bg-white border border-gray-300 rounded-xl p-8 shadow-sm">
                <h2 class="text-lg font-bold text-[#1e1e2f] mb-6">Records</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                    
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <!-- Role Selection -->
                        <div>
                            <label class="block text-sm font-bold text-[#1e1e2f] mb-2">Role:</label>
                            <div class="flex gap-6">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="role" value="student" class="accent-[#1e1e2f] w-4 h-4" checked onchange="toggleRole('student')">
                                    <span class="text-sm text-gray-700">Student</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="role" value="faculty" class="accent-[#1e1e2f] w-4 h-4" onchange="toggleRole('faculty')">
                                    <span class="text-sm text-gray-700">Faculty</span>
                                </label>
                            </div>
                        </div>

                        <!-- Full Name Stack -->
                        <div>
                            <label class="block text-sm font-bold text-[#1e1e2f] mb-2">Full Name:</label>
                            <div class="space-y-3">
                                <input type="text" id="first-name" name="first_name" placeholder="First Name" required class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B] transition-colors" />
                                <input type="text" id="middle-name" name="middle_name" placeholder="Middle Name" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B] transition-colors" />
                                <input type="text" id="last-name" name="last_name" placeholder="Last Name" required class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B] transition-colors" />
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Status -->
                        <div>
                            <label class="block text-sm font-bold text-[#1e1e2f] mb-2">Status:</label>
                            <div class="relative">
                                <select id="status" name="status" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 bg-white appearance-none focus:outline-none focus:border-[#B8860B] cursor-pointer">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                </div>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="mt-[5.5rem]"> <!-- Spacer to align with Name fields -->
                            <label class="block text-sm font-bold text-[#1e1e2f] mb-2">Email Address:</label>
                            <input type="email" id="email" name="email" placeholder="email@plm.edu.ph" required class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B] transition-colors" />
                        </div>
                    </div>

                </div>
            </div>

            <!-- 2. ACADEMIC DETAILS PANEL (Dynamic) -->
            <div class="bg-white border border-gray-300 rounded-xl p-8 shadow-sm">
                <h2 class="text-lg font-bold text-[#1e1e2f] mb-6">Academic Details</h2>

                <!-- STUDENT FORM (Default) -->
                <div id="student-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6 fade-in">
                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Student No.:</label>
                        <input type="text" id="student-no" name="student_no" placeholder="2024-xxxxx" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B]" />
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Program/Level:</label>
                        <div class="relative">
                            <select id="program" name="program" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-500 bg-white appearance-none focus:outline-none focus:border-[#B8860B]">
                                <option value="BSCS">Bachelor of Science in CS</option>
                                <option value="BSIT">Bachelor of Science in IT</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Year Level:</label>
                        <input type="text" id="year-level" name="year_level" placeholder="2nd Year" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B]" />
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Admitted Date:</label>
                        <div class="relative">
                            <input type="date" id="student-admitted" name="student_admitted_date" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-500 bg-white focus:outline-none focus:border-[#B8860B]" />
                        </div>
                    </div>
                </div>

                <!-- FACULTY FORM (Hidden initially) -->
                <div id="faculty-form" class="hidden grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6 fade-in">
                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Faculty ID:</label>
                        <input type="text" id="faculty-id" name="faculty_id" placeholder="FAC-2024-xxx" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B]" />
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Employee Type:</label>
                        <div class="relative">
                            <select id="employee-type" name="employee_type" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-500 bg-white appearance-none focus:outline-none focus:border-[#B8860B]">
                                <option value="Full-Time">Full-Time</option>
                                <option value="Part-Time">Part-Time</option>
                                <option value="Visiting">Visiting Lecturer</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Date Hired:</label>
                        <input type="date" id="date-hired" name="date_hired" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-500 bg-white focus:outline-none focus:border-[#B8860B]" />
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Admitted Date:</label>
                        <input type="date" id="faculty-admitted" name="faculty_admitted_date" class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-500 bg-white focus:outline-none focus:border-[#B8860B]" />
                    </div>
                </div>

            </div>

            <!-- 3. INITIAL CREDENTIALS PANEL -->
            <div class="bg-white border border-gray-300 rounded-xl p-8 shadow-sm">
                <h2 class="text-lg font-bold text-[#1e1e2f] mb-6">Initial Credentials</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6">
                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Initial Password:</label>
                        <input type="password" id="initial-password" name="initial_password" placeholder="********" required class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B]" />
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-sm font-bold text-[#1e1e2f]">Confirm Password:</label>
                        <input type="password" id="confirm-password" placeholder="********" required class="w-full border border-gray-400 rounded px-4 py-2.5 text-gray-700 focus:outline-none focus:border-[#B8860B]" />
                    </div>
                </div>
            </div>

            <!-- FOOTER BUTTONS -->
            <div class="flex flex-col md:flex-row justify-center items-center gap-6 pt-4">
                <button type="button" id="btn-delete" class="w-full md:w-auto px-12 py-3 rounded border border-[#B8860B] text-[#1e1e2f] font-bold text-sm hover:bg-gray-50 transition-colors">
                    Delete User
                </button>
                <button type="button" id="btn-save" class="w-full md:w-auto px-12 py-3 rounded bg-[#1e1e2f] text-white font-bold text-sm shadow-md hover:bg-[#2d2d46] transition-colors">
                    Save/Update User
                </button>
            </div>

        </form>

        <!-- GLOBAL MODAL -->
        <div id="custom-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 border border-gray-200">
                <div class="text-center">
                    <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4"></div>
                    <h3 id="modal-title" class="text-lg leading-6 font-bold text-gray-900 mb-2"></h3>
                    <p id="modal-message" class="text-sm text-gray-500"></p>
                </div>
                <div class="mt-5 sm:mt-6 grid grid-cols-2 gap-3" id="modal-actions">
                    <button id="modal-cancel" type="button" class="hidden w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:text-sm">
                        Cancel
                    </button>
                    <button id="modal-confirm" type="button" class="col-span-2 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#1e1e2f] text-base font-medium text-white hover:bg-blue-900 focus:outline-none transition-colors sm:text-sm">
                        OK
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- CLIENT SCRIPT -->
    <script is:inline>
        // ... (Same functionality script logic, maintained for save/delete) ...
        let currentRole = 'student';

        function toggleRole(role) {
            currentRole = role;
            const studentForm = document.getElementById('student-form');
            const facultyForm = document.getElementById('faculty-form');

            if (role === 'student') {
                studentForm.classList.remove('hidden');
                studentForm.classList.add('grid');
                facultyForm.classList.add('hidden');
                facultyForm.classList.remove('grid');
                toggleRequired(studentForm, true);
                toggleRequired(facultyForm, false);
            } else {
                facultyForm.classList.remove('hidden');
                facultyForm.classList.add('grid');
                studentForm.classList.add('hidden');
                studentForm.classList.remove('grid');
                toggleRequired(studentForm, false);
                toggleRequired(facultyForm, true);
            }
        }

        function toggleRequired(container, isRequired) {
            const inputs = container.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (isRequired) {
                    input.setAttribute('required', 'true');
                } else {
                    input.removeAttribute('required');
                }
            });
        }

        // --- MODAL UTILITIES ---
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalIcon = document.getElementById('modal-icon');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');

        function showModal(title, message, type = 'success', onConfirm = null) {
            if (modalTitle) modalTitle.textContent = title;
            if (modalMessage) modalMessage.textContent = message;
            
            if (type === 'error') {
                modalIcon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4";
                modalIcon.innerHTML = `<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            } else if (type === 'warning') {
                modalIcon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4";
                modalIcon.innerHTML = `<svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
            } else {
                modalIcon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4";
                modalIcon.innerHTML = `<svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            }

            if (onConfirm) {
                modalCancelBtn.classList.remove('hidden');
                modalConfirmBtn.classList.remove('col-span-2');
                modalConfirmBtn.textContent = "Confirm";
                
                const newConfirm = modalConfirmBtn.cloneNode(true);
                modalConfirmBtn.parentNode.replaceChild(newConfirm, modalConfirmBtn);
                newConfirm.addEventListener('click', () => { closeModal(); onConfirm(); });
            } else {
                modalCancelBtn.classList.add('hidden');
                modalConfirmBtn.classList.add('col-span-2');
                modalConfirmBtn.textContent = "OK";
                
                const newConfirm = modalConfirmBtn.cloneNode(true);
                modalConfirmBtn.parentNode.replaceChild(newConfirm, modalConfirmBtn);
                newConfirm.addEventListener('click', closeModal);
            }

            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        if (modalCancelBtn) modalCancelBtn.addEventListener('click', closeModal);

        // --- BUTTON FUNCTIONALITY ---
        const btnSave = document.getElementById('btn-save');
        const btnDelete = document.getElementById('btn-delete');

        window.addEventListener('DOMContentLoaded', () => {
            toggleRole('student');
        });

        if (btnSave) {
            btnSave.addEventListener('click', () => {
                const firstName = document.getElementById('first-name').value.trim();
                const lastName = document.getElementById('last-name').value.trim();
                const email = document.getElementById('email').value.trim();
                const initialPass = document.getElementById('initial-password').value;
                const confirmPass = document.getElementById('confirm-password').value;

                if (!firstName || !lastName || !email) {
                    showModal('Missing Information', 'Please fill in the Name and Email fields.', 'error');
                    return;
                }
                if (!initialPass || !confirmPass) {
                    showModal('Missing Information', 'Please set an Initial Password.', 'error');
                    return;
                }
                if (initialPass !== confirmPass) {
                    showModal('Password Error', 'Passwords do not match.', 'error');
                    return;
                }

                let specificData = {};
                if (currentRole === 'student') {
                    const studentNo = document.getElementById('student-no').value.trim();
                    const yearLevel = document.getElementById('year-level').value.trim();
                    const studentAdmitted = document.getElementById('student-admitted').value;
                    if (!studentNo || !yearLevel || !studentAdmitted) {
                        showModal('Missing Information', 'Please fill in all Student Academic Details.', 'error');
                        return;
                    }
                    specificData = { type: 'student', studentNo, yearLevel, admittedDate: studentAdmitted };
                } else {
                    const facultyId = document.getElementById('faculty-id').value.trim();
                    const dateHired = document.getElementById('date-hired').value;
                    const facultyAdmitted = document.getElementById('faculty-admitted').value;
                    if (!facultyId || !dateHired || !facultyAdmitted) {
                        showModal('Missing Information', 'Please fill in all Faculty Academic Details.', 'error');
                        return;
                    }
                    specificData = { type: 'faculty', facultyId, dateHired, admittedDate: facultyAdmitted };
                }

                const payload = { firstName, lastName, email, ...specificData };
                console.log("Saving to Backend:", payload);
                showModal('User Saved', `Successfully updated records for ${lastName}, ${firstName}.`, 'success');
            });
        }

        if (btnDelete) {
            btnDelete.addEventListener('click', () => {
                showModal('Confirm Deletion', 'Are you sure you want to delete this user? This action cannot be undone.', 'warning', () => {
                    console.log("Sending Delete Request to Backend...");
                    document.getElementById('user-form').reset();
                    toggleRole('student');
                    document.querySelector('input[name="role"][value="student"]').checked = true;
                    showModal('User Deleted', 'The user record has been removed.', 'success');
                });
            });
        }
    </script>

</body>
</html>