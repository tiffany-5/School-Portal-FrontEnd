---
// --- IMPORTS ---
import plmLogo from "../assets/PLMLogo.webp";
import "../styles/global.css";
import { Image } from "astro:assets";

// --- 1. TYPE DEFINITIONS ---
interface AdminProfile {
    name: string;
    role: string;
    adminId: string;
}

// --- 2. DATA FETCHING ---
async function fetchAdminProfile(): Promise<AdminProfile> {
    return {
        name: "DELA CRUZ, JUAN",
        role: "ADMIN",
        adminId: "ADMIN ID"
    };
}

const adminData = await fetchAdminProfile();

// --- 3. MOCK DATA ---
const mockClasses = [
    { id: 1, section: "CS 111-1", subject: "Introduction to Computing", professor: "Prof. A. Cruz", students: 42, status: "Submitted" },
    { id: 2, section: "CS 112-1", subject: "Computer Programming 1", professor: "Prof. B. Santos", students: 38, status: "Pending" },
    { id: 3, section: "IT 201-2", subject: "Web Development", professor: "Prof. C. Dizon", students: 40, status: "Submitted" },
];

const mockGrades = [
    { id: "2024-001", name: "SANTOS, MARIA A.", program: "BSCS", grade: "1.25", remarks: "Passed" },
    { id: "2024-002", name: "REYES, JOSE B.", program: "BSCS", grade: "1.75", remarks: "Passed" },
    { id: "2024-003", name: "LUNA, ANTONIO C.", program: "BSCS", grade: "5.00", remarks: "Failed" },
    { id: "2024-004", name: "DIZON, CARLO D.", program: "BSCS", grade: "INC", remarks: "Incomplete" },
];

// --- 4. STATE MANAGEMENT ---
const url = Astro.url;
const view = url.searchParams.get('view') || 'list'; // 'list' or 'details'
const sectionId = url.searchParams.get('section') || '';

const isDetailsView = view === 'details';
const selectedClass = mockClasses.find(c => c.section === sectionId);
---

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLM Student Portal - Change Password</title>
    <link rel="icon" href={plmLogo.src} />
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-white font-sans min-h-screen flex flex-col text-gray-800">

    <!-- HEADER SECTION -->
    <header class="w-full bg-white shadow-sm z-50">
        <div class="flex justify-center py-4">
            <div class="w-15 h-15">
                 <Image src={plmLogo} alt="PLM Logo" class="w-full h-full object-contain" loading="eager" />
            </div>
        </div>
        
        <div class="h-5 w-full bg-plm-navy border-b-9 border-[#991B1B]"></div>
        
        <nav class="border-y border-gray-200 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-around md:justify-center md:gap-4 text-sm font-medium text-gray-700">
                <!-- DROPDOWN: SYSTEM CONFIGURATION -->
                <div class="relative group">
                    <button class="px-6 py-2 rounded hover:text-[#1e1e2f] hover:bg-gray-100 transition-all flex items-center gap-1 cursor-default text-gray-700">
                        System Configuration
                        <svg class="w-2.5 h-2.5 ml-1 fill-current opacity-50" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </button>
                    <div class="invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 absolute left-1/2 transform -translate-x-1/2 top-full mt-1 w-48 bg-[#EAEAEA] border border-gray-300 shadow-xl rounded-md z-50 overflow-hidden text-[#1e1e2f]">
                        <a href="/a1_sysconfig-1?view=calendar" class="block px-4 py-3 text-center text-sm font-medium border-b border-gray-300/50 hover:bg-gray-200 transition-colors">Calendar</a>
                        <a href="/a1_sysconfig-1?view=course-creation" class="block px-4 py-3 text-center text-sm font-medium hover:bg-gray-200 transition-colors">Course Creation</a>
                    </div>
                </div>

                <a href="/a2_user-manage" class="px-6 py-2 rounded hover:text-[#1e1e2f] hover:bg-gray-100 transition-all">User Management</a>
                
                <!-- ACTIVE LINK -->
                <a href="/a3_grade-audit" class="bg-[#1e1e2f] text-white px-6 py-2 rounded shadow-sm hover:bg-[#2d2d46] transition-all">
                    Grade Audit
                </a>
                
                <a href="/a4_change-password" class="px-6 py-2 rounded hover:text-[#1e1e2f] hover:bg-gray-100 transition-all">Change Password</a>
            </div>
        </nav>

        <div class="bg-white border-b border-plm-gold/50 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
                <span class="text-gray-800">
                    Signed in as: <span class="font-bold uppercase">{adminData.name} ({adminData.adminId})</span>
                </span>
                <button class="text-[#991B1B] font-bold hover:underline text-xs tracking-wide">SIGN OUT</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow w-full max-w-7xl mx-auto p-6 md:p-8 relative">
        
        <h1 class="text-center text-2xl font-bold text-[#1e1e2f] mb-2 uppercase tracking-wide">GRADE AUDIT</h1>
        <h2 class="text-center text-gray-500 text-xs mb-8 uppercase tracking-widest border-b border-gray-200 inline-block mx-auto pb-1">
            {isDetailsView ? `Viewing: ${selectedClass?.section} - ${selectedClass?.subject}` : 'Class List'}
        </h2>

        <!-- FILTERS -->
        <div class="flex flex-wrap justify-center items-end gap-4 mb-8 bg-gray-50 p-6 rounded-lg border border-gray-200 shadow-sm">
            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-[#1e1e2f] ml-1">School Year:</label>
                <div class="relative">
                    <select id="school-year" class="filter-input appearance-none border border-[#B8860B] text-sm rounded px-4 h-10 bg-white w-40 text-gray-700 focus:outline-none focus:ring-1 focus:ring-[#B8860B]" disabled={isDetailsView}>
                        <option>2025-2026</option>
                        <option>2024-2025</option>
                    </select>
                    {!isDetailsView && <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>}
                </div>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-[#1e1e2f] ml-1">Semester:</label>
                <div class="relative">
                    <select id="semester" class="filter-input appearance-none border border-[#B8860B] text-sm rounded px-4 h-10 bg-white w-40 text-gray-700 focus:outline-none focus:ring-1 focus:ring-[#B8860B]" disabled={isDetailsView}>
                        <option>First Semester</option>
                        <option>Second Semester</option>
                    </select>
                    {!isDetailsView && <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>}
                </div>
            </div>

            {!isDetailsView && (
                <>
                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-bold text-[#1e1e2f] ml-1">Status:</label>
                        <div class="relative">
                            <select id="filter-status" class="filter-input appearance-none border border-[#B8860B] text-sm rounded px-4 h-10 bg-white w-48 text-gray-700 focus:outline-none focus:ring-1 focus:ring-[#B8860B]">
                                <option value="">All / Submitted / Pending</option>
                                <option value="Submitted">Submitted</option>
                                <option value="Pending">Pending</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-1">
                        <label class="text-xs font-bold text-[#1e1e2f] ml-1">Search:</label>
                        <div class="relative">
                            <input id="filter-search" type="text" placeholder="Search Prof or Subject Code" class="filter-input border border-[#B8860B] text-sm rounded px-4 h-10 bg-white w-64 text-gray-700 focus:outline-none focus:ring-1 focus:ring-[#B8860B] pr-10" />
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></div>
                        </div>
                    </div>

                    <button id="btn-confirm-filters" class="bg-[#1e1e2f] hover:bg-[#2d2d46] text-white text-sm font-bold h-10 px-8 rounded shadow-sm transition-colors mb-[1px]">
                        Confirm
                    </button>
                </>
            )}
            
            {isDetailsView && (
                <div class="flex items-end mb-[1px]">
                    <a href="?view=list" class="text-sm font-bold text-gray-500 hover:text-[#1e1e2f] underline h-10 flex items-center">
                        ‚Üê Back to List
                    </a>
                </div>
            )}
        </div>

        {isDetailsView ? (
            /* --- VIEW 2: DETAILS (GRADE SHEET) --- */
            <div class="animate-fade-in">
                <!-- Action Bar -->
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-[#1e1e2f] uppercase">Student Grades</h3>
                    
                    <!-- Edit Button (NOW NAVY) -->
                    <button id="btn-edit-grades" class="bg-[#1e1e2f] text-white text-sm font-bold px-6 py-2 rounded shadow hover:bg-[#2d2d46] transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        Edit Grades
                    </button>
                    
                    <!-- Save Button (Hidden initially) -->
                    <button id="btn-save-grades" class="hidden bg-green-600 text-white text-sm font-bold px-6 py-2 rounded shadow hover:bg-green-700 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        Save Changes
                    </button>
                </div>

                <div class="border border-[#B8860B] rounded-sm overflow-hidden shadow-sm">
                    <table class="w-full text-sm text-left">
                        <!-- HEADER COLOR CHANGED TO GOLD -->
                        <thead class="bg-[#B8860B] text-white uppercase text-xs font-bold">
                            <tr>
                                <th class="py-3 px-4 border-r border-white/20 w-12 text-center">#</th>
                                <th class="py-3 px-4 border-r border-white/20 w-32">Student No.</th>
                                <th class="py-3 px-4 border-r border-white/20">Student Name</th>
                                <th class="py-3 px-4 border-r border-white/20 w-24 text-center">Program</th>
                                <th class="py-3 px-4 border-r border-white/20 w-24 text-center">Final Grade</th>
                                <th class="py-3 px-4 w-32 text-center">Remarks</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white text-gray-800">
                            {mockGrades.map((student, index) => (
                                <tr class="student-grade-row border-b border-gray-200 hover:bg-gray-50">
                                    <td class="py-2 px-4 text-center border-r border-gray-200">{index + 1}</td>
                                    <td class="py-2 px-4 border-r border-gray-200 font-mono text-gray-600">{student.id}</td>
                                    <td class="py-2 px-4 border-r border-gray-200 font-bold uppercase text-[#1e1e2f]">{student.name}</td>
                                    <td class="py-2 px-4 border-r border-gray-200 text-center">{student.program}</td>
                                    <td class="py-2 px-4 border-r border-gray-200 text-center">
                                        <input 
                                            type="text" 
                                            value={student.grade} 
                                            class="grade-input w-full text-center font-bold bg-transparent border border-transparent rounded px-1 py-1 focus:bg-white focus:border-[#B8860B] focus:outline-none disabled:opacity-100" 
                                            disabled 
                                        />
                                    </td>
                                    <td class="remarks-cell py-2 px-4 text-center font-bold text-xs uppercase border-l border-gray-200">
                                        <!-- Select logic handled by JS -->
                                        <select class="remarks-select w-full bg-transparent text-center border border-transparent rounded focus:border-[#B8860B] focus:bg-white disabled:appearance-none disabled:bg-transparent" disabled>
                                            <option value="Passed" selected={student.remarks === 'Passed'}>Passed</option>
                                            <option value="Failed" selected={student.remarks === 'Failed'}>Failed</option>
                                            <option value="Incomplete" selected={student.remarks === 'Incomplete'}>Incomplete</option>
                                        </select>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        ) : (
            /* --- VIEW 1: CLASS LIST --- */
            <div class="animate-fade-in">
                <div class="border border-[#B8860B] rounded-sm overflow-hidden shadow-sm bg-white">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-[#B8860B] text-white uppercase text-xs font-bold">
                            <tr>
                                <th class="py-3 px-4 border-r border-white/20 w-12 text-center">#</th>
                                <th class="py-3 px-4 border-r border-white/20 w-32">Section</th>
                                <th class="py-3 px-4 border-r border-white/20">Subject</th>
                                <th class="py-3 px-4 border-r border-white/20">Professor</th>
                                <th class="py-3 px-4 border-r border-white/20 w-24 text-center">Students</th>
                                <th class="py-3 px-4 border-r border-white/20 w-24 text-center">Status</th>
                                <th class="py-3 px-4 w-24 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="class-list-body" class="bg-white text-gray-800">
                            {mockClasses.map((cls, index) => (
                                <tr class="class-row border-b border-gray-200 hover:bg-gray-50 transition-colors" 
                                    data-search={`${cls.subject} ${cls.professor} ${cls.section}`.toLowerCase()}
                                    data-status={cls.status}>
                                    
                                    <td class="py-3 px-4 text-center border-r border-gray-200">{index + 1}</td>
                                    <td class="py-3 px-4 border-r border-gray-200 font-bold text-[#1e1e2f]">{cls.section}</td>
                                    <td class="py-3 px-4 border-r border-gray-200">{cls.subject}</td>
                                    <td class="py-3 px-4 border-r border-gray-200">{cls.professor}</td>
                                    <td class="py-3 px-4 border-r border-gray-200 text-center">{cls.students}</td>
                                    <td class="py-3 px-4 border-r border-gray-200 text-center">
                                        <span class={`text-[10px] uppercase font-bold px-2 py-1 rounded-full ${cls.status === 'Submitted' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                            {cls.status}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4 text-center">
                                        <a href={`?view=details&section=${cls.section}`} class="bg-[#1e1e2f] text-white text-xs font-bold px-3 py-1.5 rounded hover:bg-[#2d2d46] transition-colors">
                                            Edit
                                        </a>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <div id="no-results" class="hidden py-12 text-center text-gray-500 italic">No classes found matching your criteria.</div>
                </div>
            </div>
        )}

        <!-- GLOBAL MODAL -->
        <div id="custom-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 border border-gray-200">
                <div class="text-center">
                    <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <h3 id="modal-title" class="text-lg leading-6 font-bold text-gray-900 mb-2">Success</h3>
                    <p id="modal-message" class="text-sm text-gray-500">Operation completed successfully.</p>
                </div>
                <div class="mt-5 sm:mt-6">
                    <button id="modal-close" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-[#1e1e2f] text-base font-medium text-white hover:bg-blue-900 focus:outline-none transition-colors">
                        OK
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script is:inline>
        // --- 1. FILTER LOGIC (List View) ---
        const btnConfirm = document.getElementById('btn-confirm-filters');
        
        if (btnConfirm) {
            btnConfirm.addEventListener('click', () => {
                const searchVal = document.getElementById('filter-search').value.toLowerCase();
                const statusVal = document.getElementById('filter-status').value;
                const rows = document.querySelectorAll('.class-row');
                const filterInputs = document.querySelectorAll('.filter-input');
                let hasResults = false;

                // Disable inputs to "Fix" the filter
                filterInputs.forEach(input => input.disabled = true);
                btnConfirm.disabled = true;
                btnConfirm.classList.add('opacity-50', 'cursor-not-allowed');
                btnConfirm.innerText = "Locked";

                rows.forEach(row => {
                    const rowSearch = row.dataset.search;
                    const rowStatus = row.dataset.status;
                    
                    const matchesSearch = rowSearch.includes(searchVal);
                    const matchesStatus = statusVal === "" || rowStatus === statusVal;

                    if (matchesSearch && matchesStatus) {
                        row.classList.remove('hidden');
                        hasResults = true;
                    } else {
                        row.classList.add('hidden');
                    }
                });

                const noResults = document.getElementById('no-results');
                if (noResults) {
                    if (!hasResults) noResults.classList.remove('hidden');
                    else noResults.classList.add('hidden');
                }
            });
        }

        // --- 2. EDIT MODE LOGIC (Details View) ---
        const btnEdit = document.getElementById('btn-edit-grades');
        const btnSave = document.getElementById('btn-save-grades');
        const gradeInputs = document.querySelectorAll('.grade-input');
        const remarksSelects = document.querySelectorAll('.remarks-select');

        // Function to update remarks color based on value
        function updateRemarksColor(select) {
            const val = select.value;
            select.className = `remarks-select w-full bg-transparent text-center border border-transparent rounded focus:border-[#B8860B] focus:bg-white disabled:appearance-none disabled:bg-transparent font-bold text-xs uppercase`;
            
            if (val === 'Failed') select.classList.add('text-red-600');
            else if (val === 'Passed') select.classList.add('text-green-700');
            else select.classList.add('text-orange-600'); // For Incomplete
        }

        // Initialize colors
        remarksSelects.forEach(sel => updateRemarksColor(sel));

        // Auto-compute remarks when grade changes
        gradeInputs.forEach((input, index) => {
            input.addEventListener('input', () => {
                const gradeVal = parseFloat(input.value);
                const relatedSelect = remarksSelects[index];
                
                if (!isNaN(gradeVal)) {
                    if (gradeVal > 3.00 || gradeVal === 5.00) {
                        relatedSelect.value = 'Failed';
                    } else {
                        relatedSelect.value = 'Passed';
                    }
                } else if (input.value.toUpperCase() === 'INC') {
                    relatedSelect.value = 'Incomplete';
                }
                
                updateRemarksColor(relatedSelect);
            });
        });

        // Ensure remarks selects update their color when manually changed (if needed)
        remarksSelects.forEach(sel => {
            sel.addEventListener('change', () => updateRemarksColor(sel));
        });

        if (btnEdit) {
            btnEdit.addEventListener('click', () => {
                // Toggle UI
                btnEdit.classList.add('hidden');
                btnSave.classList.remove('hidden');
                btnSave.classList.add('flex');

                // Enable Inputs
                document.querySelectorAll('.grade-input, .remarks-select').forEach(input => {
                    input.disabled = false;
                    input.parentElement.classList.add('bg-yellow-50'); // Highlight editable cells
                });
            });
        }

        if (btnSave) {
            btnSave.addEventListener('click', () => {
                // Toggle UI
                btnSave.classList.add('hidden');
                btnSave.classList.remove('flex');
                btnEdit.classList.remove('hidden');

                // Disable Inputs
                document.querySelectorAll('.grade-input, .remarks-select').forEach(input => {
                    input.disabled = true;
                    input.parentElement.classList.remove('bg-yellow-50');
                });

                // Show Success
                const modal = document.getElementById('custom-modal');
                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
            });
        }

        // Modal Close Logic
        document.getElementById('modal-close')?.addEventListener('click', () => {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
        });
    </script>

</body>
</html>