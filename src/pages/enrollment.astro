---
// --- IMPORTS ---
import plmLogo from "../assets/PLMLogo.webp";
import "../styles/global.css";
import { Image } from "astro:assets";

// --- 1. TYPE DEFINITIONS ---
interface StudentProfile {
    firstName: string;
    lastName: string;
    studentId: string;
}

interface SubjectItem {
    id: string;
    code: string;
    description: string;
    units: number;
    schedules: string[];
    type: "regular" | "back_subject";
}

// --- 2. FETCH DATA ---
async function fetchStudentProfile(): Promise<StudentProfile> {
    return { firstName: "EMMANUEL A.", lastName: "PEREZ", studentId: "202390029" };
}

// Mock Database
const availableSubjects: SubjectItem[] = [
    // Prerequisite / Back Subjects
    { 
        id: "subj-4", 
        code: "PE 003", 
        description: "PATH-FIT 3 (DANCE)", 
        units: 2, 
        schedules: ["Sat 1:00PM-3:00PM", "Sun 10:00AM-12:00PM"],
        type: "back_subject"
    },
    // Regular Subjects
    { 
        id: "subj-1", 
        code: "CS 211", 
        description: "DATA STRUCTURES AND ALGORITHMS", 
        units: 3, 
        schedules: ["M/Th 10:30AM-1:30PM", "T/F 7:30AM-10:30AM"],
        type: "regular"
    },
    { 
        id: "subj-2", 
        code: "CS 212", 
        description: "OBJECT ORIENTED PROGRAMMING", 
        units: 3, 
        schedules: ["T/F 1:00PM-4:00PM", "W 8:00AM-11:00AM"],
        type: "regular"
    },
    { 
        id: "subj-3", 
        code: "GEC 005", 
        description: "PURPOSIVE COMMUNICATION", 
        units: 3, 
        schedules: ["Sat 8:00AM-11:00AM", "Sat 1:00PM-4:00PM"],
        type: "regular"
    },
    { 
        id: "subj-5", 
        code: "NSTP 002", 
        description: "CIVIC WELFARE TRAINING SERVICE 2", 
        units: 3, 
        schedules: ["Sun 7:00AM-12:00PM"],
        type: "regular"
    }
];

const studentData = await fetchStudentProfile();

// --- 3. SERVER-SIDE LOGIC ---
const yearParam = Astro.url.searchParams.get('year');
const semParam = Astro.url.searchParams.get('sem');
const stepParam = Astro.url.searchParams.get('step') || '1';

// We are in Step 2 if the URL says step=2 AND we have year/sem params
const isStep2 = stepParam === '2' && !!yearParam && !!semParam;
---

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLM Student Portal - Enrollment</title>
    <link rel="icon" href={plmLogo.src} />
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-white font-sans min-h-screen flex flex-col text-gray-800">

    <!-- HEADER SECTION -->
    <header class="w-full bg-white shadow-sm z-50">
        <div class="flex justify-center py-4">
            <div class="w-15 h-15">
                 <Image src={plmLogo} alt="PLM Logo" class="w-full h-full object-contain" loading="eager" />
            </div>
        </div>
<div class="h-5 w-full bg-plm-navy border-b-9 border-[#991B1B]"></div>
        <nav class="border-y border-gray-200 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-around md:justify-center md:gap-12 text-sm font-medium text-gray-700">
                <a href="/dashboard" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Home</a>
                <a href="/student_schedule" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Schedule</a>
                <a href="/grade" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/20 transition-all">Grade</a>
                <a href="/enrollment" class="bg-plm-navy text-white px-6 py-2 rounded shadow-sm hover:bg-opacity-90 transition-all">Enrollment</a>
                <a href="/personalinfo" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Personal Info</a>
                <a href="/change-password" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/20 transition-all">Change Password</a>
            </div>
        </nav>

        <div class="bg-white border-b border-plm-gold/50 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
                <span class="text-gray-800">
                    Signed in as: <span class="font-bold uppercase">{studentData.lastName}, {studentData.firstName}</span> <span class="font-bold">({studentData.studentId})</span>
                </span>
                <button class="text-[#991B1B] font-bold hover:underline text-xs tracking-wide">SIGN OUT</button>
            </div>
        </div>
    </header>
    <!-- MAIN CONTENT -->
    <main class="flex-grow w-full max-w-7xl mx-auto p-6 md:p-8 relative">
        
        <div id="enrollment-container">
            
            <!-- ==========================
                 STEP 1: SELECTION VIEW 
            =========================== -->
            <div id="step-1" class={`${isStep2 ? 'hidden' : ''} animate-fade-in`}>
                <h1 class="text-center text-2xl font-bold text-plm-navy mb-8 uppercase tracking-wide">MY ENROLLMENT</h1>

                <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-semibold text-plm-navy">School Year:</label>
                        <select id="school-year" class="border border-plm-gold text-sm rounded px-4 h-9 bg-white w-48 focus:outline-none focus:ring-1 focus:ring-plm-gold cursor-pointer">
                            <option value="2025-2026">2025-2026</option>
                            <option value="2024-2025">2024-2025</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-semibold text-plm-navy">Semester:</label>
                        <select id="semester" class="border border-plm-gold text-sm rounded px-4 h-9 bg-white w-48 focus:outline-none focus:ring-1 focus:ring-plm-gold cursor-pointer">
                            <option value="First Semester">First Semester</option>
                            <option value="Second Semester">Second Semester</option>
                        </select>
                    </div>
                    <button id="btn-to-step-2" class="bg-[#1e1e2f] hover:bg-plm-navy text-white text-sm font-medium h-9 px-8 rounded shadow-sm transition-colors ml-2">
                        Confirm
                    </button>
                </div>

                <!-- Prerequisite Legend Bar -->
                <div class="w-full bg-[#E31C23] text-white py-2 px-4 text-center font-bold text-sm uppercase shadow-sm">
                    Prerequisite
                </div>
            </div>

            <!-- ==========================
                 STEP 2: AVAILABLE SUBJECTS 
            =========================== -->
            <div id="step-2" class={`${!isStep2 ? 'hidden' : ''} animate-fade-in`}>
                <h1 class="text-center text-2xl font-bold text-plm-navy mb-4 uppercase tracking-wide">MY ENROLLMENT</h1>

                <!-- Filters Display (Read Only) -->
                <div class="flex justify-center items-center gap-6 mb-6 text-sm">
                    <div>
                        <span class="font-bold text-plm-navy">School Year:</span> 
                        <span class="border border-plm-gold px-4 py-1.5 rounded ml-2 bg-white text-gray-700 shadow-sm">{yearParam}</span>
                    </div>
                    <div>
                        <span class="font-bold text-plm-navy">Semester:</span> 
                        <span class="border border-plm-gold px-4 py-1.5 rounded ml-2 bg-white text-gray-700 shadow-sm">{semParam}</span>
                    </div>
                </div>

                <div class="w-full bg-[#E31C23] text-white py-1.5 px-4 mb-6 font-bold text-xs uppercase shadow-sm flex items-center">
                    <span class="font-bold mr-2">LEGEND:</span> 
                    <span class="bg-white/20 px-2 py-0.5 rounded text-[10px] tracking-wide">Prerequisite / Back Subjects</span>
                </div>

                <!-- 1. PREREQUISITE SUBJECTS TABLE -->
                <div class="mb-8">
                    <h2 class="text-lg font-bold text-[#E31C23] mb-2 uppercase flex items-center gap-2 border-b-2 border-[#E31C23] inline-block pb-1">
                        Prerequisite Subjects
                    </h2>
                    <div class="overflow-x-auto border border-[#E31C23] shadow-sm">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-[#E31C23] text-white uppercase text-xs font-bold">
                                <tr>
                                    <th class="py-2.5 px-3 border-r border-white/20 w-10 text-center">#</th>
                                    <th class="py-2.5 px-3 border-r border-white/20 w-32">Subject Code</th>
                                    <th class="py-2.5 px-3 border-r border-white/20">Description</th>
                                    <th class="py-2.5 px-3 border-r border-white/20 w-16 text-center">Units</th>
                                    <th class="py-2.5 px-3 text-center">Schedule</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-900 bg-red-50">
                                {availableSubjects.filter(s => s.type === 'back_subject').map((subject, index) => (
                                    <tr class="border-b border-red-200 hover:bg-red-100 transition-colors">
                                        <td class="py-2 px-3 border-r border-red-200 text-center">
                                            <input type="checkbox" class="subject-checkbox w-4 h-4 text-red-600 rounded border-gray-300 focus:ring-red-500 cursor-pointer"
                                                data-id={subject.id} data-units={subject.units} data-code={subject.code} data-desc={subject.description} />
                                        </td>
                                        <td class="py-2 px-3 border-r border-red-200 font-bold text-red-900">{subject.code}</td>
                                        <td class="py-2 px-3 border-r border-red-200 uppercase font-medium">{subject.description}</td>
                                        <td class="py-2 px-3 border-r border-red-200 text-center font-bold">{subject.units}</td>
                                        <td class="py-2 px-2 text-center">
                                            <select class="subject-schedule w-full border border-red-300 text-xs rounded px-2 py-1.5 bg-white focus:border-red-500 outline-none cursor-pointer" data-id={subject.id}>
                                                <option value="" disabled selected>- select schedule -</option>
                                                {subject.schedules.map(sched => <option value={sched}>{sched}</option>)}
                                            </select>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. REGULAR SUBJECTS TABLE -->
                <div>
                    <h2 class="text-lg font-bold text-plm-navy mb-2 uppercase border-b-2 border-plm-gold inline-block pb-1">Available Subjects</h2>
                    <div class="overflow-x-auto border border-plm-gold shadow-sm">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-[#7F1D1D] text-white uppercase text-xs font-bold">
                                <tr>
                                    <th class="py-2.5 px-3 border-r border-[#B8860B] w-10 text-center">#</th>
                                    <th class="py-2.5 px-3 border-r border-[#B8860B] w-32">Subject Code</th>
                                    <th class="py-2.5 px-3 border-r border-[#B8860B]">Description</th>
                                    <th class="py-2.5 px-3 border-r border-[#B8860B] w-16 text-center">Units</th>
                                    <th class="py-2.5 px-3 text-center">Schedule</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-900 bg-white">
                                {availableSubjects.filter(s => s.type === 'regular').map((subject, index) => (
                                    <tr class="border-b border-plm-gold/30 hover:bg-gray-50 transition-colors">
                                        <td class="py-2 px-3 border-r border-plm-gold/50 text-center">
                                            <input type="checkbox" class="subject-checkbox w-4 h-4 text-plm-navy rounded border-gray-300 focus:ring-plm-navy cursor-pointer"
                                                data-id={subject.id} data-units={subject.units} data-code={subject.code} data-desc={subject.description} />
                                        </td>
                                        <td class="py-2 px-3 border-r border-plm-gold/50 font-bold">{subject.code}</td>
                                        <td class="py-2 px-3 border-r border-plm-gold/50 uppercase font-medium">{subject.description}</td>
                                        <td class="py-2 px-3 border-r border-plm-gold/50 text-center font-bold">{subject.units}</td>
                                        <td class="py-2 px-2 text-center">
                                            <select class="subject-schedule w-full border border-gray-300 text-xs rounded px-2 py-1.5 bg-white focus:border-plm-navy outline-none cursor-pointer" data-id={subject.id}>
                                                <option value="" disabled selected>- select schedule -</option>
                                                {subject.schedules.map(sched => <option value={sched}>{sched}</option>)}
                                            </select>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="w-full bg-[#7F1D1D] text-white py-3 px-6 flex justify-between items-center shadow-md mt-8 rounded-sm">
                    <span class="font-bold text-sm">
                        Total Units Enrolled: <span id="total-units-display" class="text-lg ml-2 font-mono font-bold">0</span>
                    </span>
                    <div class="flex gap-3">
                        <button id="btn-cancel-step2" class="bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-2 px-6 rounded shadow border border-white/10 transition-transform active:scale-95">
                            Cancel
                        </button>
                        <button id="btn-to-step-3" class="bg-[#1e1e2f] hover:bg-gray-800 text-white text-sm font-bold py-2 px-8 rounded shadow border border-white/20 transition-transform active:scale-95">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>

            <!-- ==========================
                 STEP 3: CONFIRMATION 
            =========================== -->
            <div id="step-3" class="hidden animate-fade-in">
                <h1 class="text-center text-2xl font-bold text-plm-navy mb-8 uppercase tracking-wide">ENROLLMENT CONFIRMATION</h1>

                <h2 class="text-sm font-bold text-black mb-2 uppercase border-b-2 border-black inline-block pb-1">SCHEDULE OF SUBJECT/S</h2>

                <div class="overflow-x-auto border border-plm-gold mb-0 shadow-sm">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-[#7F1D1D] text-white uppercase text-xs font-bold">
                            <tr>
                                <th class="py-2.5 px-3 border-r border-[#B8860B] w-10 text-center">#</th>
                                <th class="py-2.5 px-3 border-r border-[#B8860B] w-32">Subject Code</th>
                                <th class="py-2.5 px-3 border-r border-[#B8860B]">Description</th>
                                <th class="py-2.5 px-3 border-r border-[#B8860B] w-16 text-center">Units</th>
                                <th class="py-2.5 px-3">Schedule</th>
                            </tr>
                        </thead>
                        <tbody id="confirmation-table-body" class="text-gray-900 bg-white">
                            <!-- Rows injected by JS -->
                        </tbody>
                        <tfoot class="border-t-2 border-plm-gold font-bold bg-gray-50 text-gray-900">
                            <tr>
                                <td colspan="3" class="py-3 px-3 border-r border-plm-gold text-right uppercase text-gray-600">Total Units</td>
                                <td class="py-3 px-3 border-r border-plm-gold text-center text-lg" id="final-units">0</td>
                                <td class="py-3 px-3 text-xs text-gray-500 font-normal">
                                    Date: <span id="reg-date" class="font-bold text-black"></span>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <p class="text-xs text-gray-500 italic mt-3 mb-8">* Page for finalizing the enrollment. Please review your subjects carefully.</p>

                <div class="flex justify-end gap-4 border-t border-gray-200 pt-6">
                    <button id="btn-cancel-step3" class="bg-gray-500 hover:bg-gray-600 text-white text-sm font-bold py-2.5 px-8 rounded shadow transition-transform active:scale-95">
                        Cancel
                    </button>
                    <button id="btn-enroll" class="bg-[#1e1e2f] hover:bg-plm-navy text-white text-sm font-bold py-2.5 px-10 rounded shadow-lg transition-transform active:scale-95">
                        Enroll
                    </button>
                </div>
            </div>

        </div>

        <!-- SUCCESS/ERROR MODAL -->
        <div id="custom-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 border border-gray-200">
                <div class="text-center">
                    <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4">
                        <!-- Icon injected here -->
                    </div>
                    <h3 id="modal-title" class="text-lg leading-6 font-bold text-gray-900 mb-2"></h3>
                    <div class="mt-2 px-2">
                        <p id="modal-message" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6">
                    <button id="modal-close" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-plm-navy text-base font-medium text-white hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-plm-navy sm:text-sm transition-colors">
                        OK
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- CLIENT-SIDE LOGIC -->
    <script>
        // --- VARIABLES ---
        const btnToStep2 = document.getElementById('btn-to-step-2');
        const btnToStep3 = document.getElementById('btn-to-step-3');
        const btnEnroll = document.getElementById('btn-enroll');
        const btnCancelStep2 = document.getElementById('btn-cancel-step2'); // Cancel in Step 2
        const btnCancelStep3 = document.getElementById('btn-cancel-step3'); // Cancel in Step 3
        
        const step1 = document.getElementById('step-1');
        const step2 = document.getElementById('step-2');
        const step3 = document.getElementById('step-3');

        const checkboxes = document.querySelectorAll('.subject-checkbox');
        const totalUnitsDisplay = document.getElementById('total-units-display');
        const modal = document.getElementById('custom-modal');
        const modalClose = document.getElementById('modal-close');

        // --- HELPER: SHOW MODAL ---
        function showModal(title, message, type = 'error') {
            const mTitle = document.getElementById('modal-title');
            const mMsg = document.getElementById('modal-message');
            const mIcon = document.getElementById('modal-icon');
            const mContainer = modal.querySelector('div > div');

            if (mTitle) mTitle.textContent = title;
            if (mMsg) mMsg.textContent = message;
            
            if (mIcon) {
                if (type === 'error') {
                    mIcon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4";
                    mIcon.innerHTML = `<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
                } else {
                    mIcon.className = "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4";
                    mIcon.innerHTML = `<svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                }
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
            }, 10);
        }

        if (modalClose) {
            modalClose.addEventListener('click', () => {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            });
        }

        // --- STEP 1 -> STEP 2 ---
        if (btnToStep2) {
            btnToStep2.addEventListener('click', () => {
                const year = (document.getElementById('school-year') as HTMLSelectElement).value;
                const sem = (document.getElementById('semester') as HTMLSelectElement).value;
                window.location.href = `/enrollment?step=2&year=${year}&sem=${sem}`;
            });
        }

        // --- CANCEL BUTTON (STEP 2 -> STEP 1) ---
        if (btnCancelStep2) {
            btnCancelStep2.addEventListener('click', () => {
                window.location.href = '/enrollment'; // Clears query params, effectively going back to Step 1
            });
        }

        // --- CHECKBOX LOGIC ---
        let currentTotalUnits = 0;
        let selectedSubjectsData = [];

        checkboxes.forEach(cb => {
            cb.addEventListener('change', (e) => {
                const target = e.target as HTMLInputElement;
                const units = parseInt(target.getAttribute('data-units') || '0');
                
                if (target.checked) {
                    currentTotalUnits += units;
                } else {
                    currentTotalUnits -= units;
                }
                if(totalUnitsDisplay) totalUnitsDisplay.textContent = currentTotalUnits.toString();
            });
        });

        // --- STEP 2 -> STEP 3 ---
        if (btnToStep3) {
            btnToStep3.addEventListener('click', () => {
                selectedSubjectsData = [];
                let hasError = false;

                checkboxes.forEach((cb) => {
                    const input = cb as HTMLInputElement;
                    if (input.checked) {
                        const id = input.getAttribute('data-id');
                        const code = input.getAttribute('data-code');
                        const desc = input.getAttribute('data-desc');
                        const units = input.getAttribute('data-units');
                        
                        const schedSelect = document.querySelector(`.subject-schedule[data-id="${id}"]`) as HTMLSelectElement;
                        const schedule = schedSelect ? schedSelect.value : '';

                        if (!schedule) {
                            showModal('Missing Schedule', `Please select a schedule for ${code}`, 'error');
                            hasError = true;
                            return;
                        }
                        selectedSubjectsData.push({ code, desc, units, schedule });
                    }
                });

                if (hasError) return;
                if (selectedSubjectsData.length === 0) {
                    showModal('No Subjects Selected', 'Please select at least one subject to continue.', 'error');
                    return;
                }

                // Transition
                step2.classList.add('hidden');
                step3.classList.remove('hidden');
                
                // Scroll to top
                window.scrollTo(0, 0);

                // Populate Table
                const tbody = document.getElementById('confirmation-table-body');
                const finalUnits = document.getElementById('final-units');
                const regDate = document.getElementById('reg-date');

                if (tbody && finalUnits && regDate) {
                    tbody.innerHTML = '';
                    selectedSubjectsData.forEach((item, idx) => {
                        const row = `
                            <tr class="border-b border-plm-gold/30">
                                <td class="py-2 px-3 border-r border-plm-gold/50 text-center font-bold">${idx + 1}</td>
                                <td class="py-2 px-3 border-r border-plm-gold/50 font-bold">${item.code}</td>
                                <td class="py-2 px-3 border-r border-plm-gold/50 uppercase font-medium">${item.desc}</td>
                                <td class="py-2 px-3 border-r border-plm-gold/50 text-center font-bold">${item.units}</td>
                                <td class="py-2 px-3 text-red-800 font-bold text-xs uppercase">${item.schedule}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });

                    finalUnits.textContent = currentTotalUnits.toString();
                    regDate.textContent = new Date().toLocaleDateString();
                }
            });
        }

        // --- CANCEL BUTTON (STEP 3 -> STEP 2) ---
        if (btnCancelStep3) {
            btnCancelStep3.addEventListener('click', () => {
                step3.classList.add('hidden');
                step2.classList.remove('hidden');
            });
        }

        // --- FINAL ENROLL ---
        if (btnEnroll) {
            btnEnroll.addEventListener('click', () => {
                showModal('Enrollment Successful', 'You have been successfully enrolled. Redirecting to your schedule...', 'success');
                setTimeout(() => {
                    window.location.href = '/student_schedule';
                }, 2000);
            });
        }
    </script>
</body>
</html>