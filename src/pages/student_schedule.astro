---
// --- IMPORTS ---
import plmLogo from "../assets/PLMLogo.webp";
import "../styles/global.css";
import { Image } from "astro:assets";

// --- 1. TYPE DEFINITIONS ---
interface StudentProfile {
    firstName: string;
    lastName: string;
    studentId: string;
}

interface ScheduleItem {
    code: string;
    section: string;
    description: string;
    units: number;
    schedule: string;
    professor: string;
    status: "Enrolled" | "Dropped" | "Withdrawn" | "Passed" | "Completed";
}

// --- 2. FETCH DATA (SIMULATED) ---

// A. Get User Info
async function fetchStudentProfile(): Promise<StudentProfile> {
    return {
        firstName: "EMMANUEL A.",
        lastName: "PEREZ",
        studentId: "202390029"
    };
}

// B. Database of Schedules
const scheduleDatabase: Record<string, Record<string, ScheduleItem[]>> = {
    "2024-2025": {
        "First Semester": [
            { code: "CS 111", section: "1", description: "INTRODUCTION TO COMPUTING", units: 3, schedule: "M 8:00AM-11:00AM", professor: "Prof. A. Cruz", status: "Passed" },
            { code: "CS 112", section: "1", description: "COMPUTER PROGRAMMING 1", units: 3, schedule: "T/Th 1:00PM-3:00PM", professor: "Prof. B. Santos", status: "Passed" },
            { code: "GEC 001", section: "2", description: "UNDERSTANDING THE SELF", units: 3, schedule: "W 9:00AM-12:00PM", professor: "Dr. C. Dizon", status: "Passed" },
            { code: "GEC 002", section: "2", description: "READINGS IN PHILIPPINE HISTORY", units: 3, schedule: "F 2:00PM-5:00PM", professor: "Mr. D. Ocampo", status: "Passed" },
            { code: "PE 001", section: "5", description: "PATH-FIT 1 (MOVEMENT ENHANCEMENT)", units: 2, schedule: "Sat 8:00AM-10:00AM", professor: "Ms. E. Go", status: "Passed" },
            { code: "NSTP 001", section: "1", description: "CIVIC WELFARE TRAINING SERVICE 1", units: 3, schedule: "Sun 7:00AM-12:00PM", professor: "NSTP Dept.", status: "Passed" }
        ],
        "Second Semester": [
            { code: "CS 121", section: "1", description: "COMPUTER PROGRAMMING 2", units: 3, schedule: "M/W 10:00AM-12:00PM", professor: "Prof. B. Santos", status: "Passed" },
            { code: "CS 122", section: "1", description: "DISCRETE STRUCTURES 1", units: 3, schedule: "T/Th 8:00AM-9:30AM", professor: "Engr. F. Lima", status: "Passed" },
            { code: "GEC 003", section: "3", description: "THE CONTEMPORARY WORLD", units: 3, schedule: "F 1:00PM-4:00PM", professor: "Ms. G. Pineda", status: "Passed" },
            { code: "GEC 004", section: "1", description: "MATHEMATICS IN THE MODERN WORLD", units: 3, schedule: "Sat 1:00PM-4:00PM", professor: "Mr. H. Lee", status: "Passed" },
            { code: "PE 002", section: "5", description: "PATH-FIT 2 (FITNESS EXERCISES)", units: 2, schedule: "Sat 10:00AM-12:00PM", professor: "Mr. K. Tan", status: "Passed" },
            { code: "NSTP 002", section: "1", description: "CIVIC WELFARE TRAINING SERVICE 2", units: 3, schedule: "Sun 7:00AM-12:00PM", professor: "NSTP Dept.", status: "Passed" }
        ]
    },
    "2025-2026": {
        "First Semester": [
            { code: "CS 211", section: "1", description: "DATA STRUCTURES AND ALGORITHMS", units: 3, schedule: "M/Th 10:30AM-1:30PM", professor: "Engr. J. Dela Cruz", status: "Enrolled" },
            { code: "CS 212", section: "1", description: "OBJECT ORIENTED PROGRAMMING", units: 3, schedule: "T/F 7:30AM-10:30AM", professor: "Prof. M. Santos", status: "Enrolled" },
            { code: "GEC 005", section: "2", description: "PURPOSIVE COMMUNICATION", units: 3, schedule: "Sat 8:00AM-11:00AM", professor: "Ms. L. Bautista", status: "Enrolled" },
            { code: "PE 003", section: "5", description: "PATH-FIT 3 (DANCE)", units: 2, schedule: "Sat 1:00PM-3:00PM", professor: "Mr. K. Tan", status: "Enrolled" },
            { code: "GEC 006", section: "3", description: "ART APPRECIATION", units: 3, schedule: "W 1:00PM-4:00PM", professor: "Mr. R. Garcia", status: "Enrolled" }
        ],
        "Second Semester": [] // Future data
    }
};

// C. Fetch Logic based on URL Params
const yearParam = Astro.url.searchParams.get('year') || "2025-2026";
const semParam = Astro.url.searchParams.get('sem') || "First Semester";

async function fetchSchedule(year: string, sem: string): Promise<ScheduleItem[]> {
    // Return the data from our "database" or an empty array if not found
    return scheduleDatabase[year]?.[sem] || [];
}

// Execute the fetches
const studentData = await fetchStudentProfile();
const scheduleData = await fetchSchedule(yearParam, semParam);
const totalUnits = scheduleData.reduce((sum, item) => sum + item.units, 0);
---

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLM Student Portal - Schedule</title>
    <link rel="icon" href={plmLogo.src} />
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-white font-sans min-h-screen flex flex-col text-gray-800">

    <!-- HEADER SECTION -->
    <header class="w-full bg-white shadow-sm z-50">
        <div class="flex justify-center py-4">
            <div class="w-15 h-15">
                 <Image src={plmLogo} alt="PLM Logo" class="w-full h-full object-contain" loading="eager" />
            </div>
        </div>
<div class="h-5 w-full bg-plm-navy border-b-9 border-[#991B1B]"></div>
        <nav class="border-y border-gray-200 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-around md:justify-center md:gap-12 text-sm font-medium text-gray-700">
                <a href="/dashboard" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Home</a>
                <a href="#" class="bg-plm-navy text-white px-6 py-2 rounded shadow-sm hover:bg-opacity-90 transition-all">Schedule</a>
                <a href="#" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Grade</a>
                <a href="#" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Enrollment</a>
                <a href="#" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Personal Info</a>
                <a href="#" class="px-6 py-2 rounded hover:text-plm-navy hover:bg-plm-navy/10 transition-all">Change Password</a>
            </div>
        </nav>

        <div class="bg-white border-b border-plm-gold/50 py-2">
            <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-sm">
                <span class="text-gray-800">
                    Signed in as: <span class="font-bold uppercase">{studentData.lastName}, {studentData.firstName}</span> <span class="font-bold">({studentData.studentId})</span>
                </span>
                <button class="text-[#991B1B] font-bold hover:underline text-xs tracking-wide">SIGN OUT</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow w-full max-w-6xl mx-auto p-6 md:p-8">
        
        <h1 class="text-center text-2xl font-bold text-plm-navy mb-8 uppercase tracking-wide">My Schedule</h1>

        <!-- FILTERS -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8">
            
            <div class="flex items-center gap-2">
                <label for="school-year" class="text-sm font-semibold text-plm-navy">School Year:</label>
                <div class="relative">
                    <!-- We check the selected attribute based on the current URL param -->
                    <select id="school-year" class="appearance-none border border-plm-gold text-sm rounded px-4 py-1.5 pr-8 bg-white focus:outline-none focus:ring-1 focus:ring-plm-gold w-40">
                        <option value="2025-2026" selected={yearParam === "2025-2026"}>2025-2026</option>
                        <option value="2024-2025" selected={yearParam === "2024-2025"}>2024-2025</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <label for="semester" class="text-sm font-semibold text-plm-navy">Semester:</label>
                <div class="relative">
                    <select id="semester" class="appearance-none border border-plm-gold text-sm rounded px-4 py-1.5 pr-8 bg-white focus:outline-none focus:ring-1 focus:ring-plm-gold w-40">
                        <option value="First Semester" selected={semParam === "First Semester"}>First Semester</option>
                        <option value="Second Semester" selected={semParam === "Second Semester"}>Second Semester</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
            </div>

            <!-- BUTTON WITH ID FOR SCRIPT -->
            <button id="confirm-btn" class="bg-[#1e1e2f] hover:bg-plm-navy text-white text-sm font-medium py-1.5 px-6 rounded shadow-sm transition-colors ml-2 cursor-pointer">
                Confirm
            </button>
        </div>

        <!-- SCHEDULE TABLE -->
        <div class="overflow-x-auto border border-plm-gold mb-8">
            <table class="w-full text-sm text-left">
                <thead class="bg-[#7F1D1D] text-white uppercase text-xs font-bold">
                    <tr>
                        <th class="py-2 px-3 border-r border-[#B8860B] w-10 text-center">#</th>
                        <th class="py-2 px-3 border-r border-[#B8860B]">Subject Code</th>
                        <th class="py-2 px-3 border-r border-[#B8860B]">Section</th>
                        <th class="py-2 px-3 border-r border-[#B8860B] w-1/3">Description</th>
                        <th class="py-2 px-3 border-r border-[#B8860B] w-16 text-center">Units</th>
                        <th class="py-2 px-3 border-r border-[#B8860B]">Schedule</th>
                        <th class="py-2 px-3 border-r border-[#B8860B]">Professor</th>
                        <th class="py-2 px-3">Status</th>
                    </tr>
                </thead>
                <tbody class="text-gray-900">
                    {scheduleData.length > 0 ? scheduleData.map((item, index) => (
                        <tr class="border-b border-plm-gold/30 hover:bg-gray-50">
                            <td class="py-2 px-3 border-r border-plm-gold/50 text-center font-bold">{index + 1}</td>
                            <td class="py-2 px-3 border-r border-plm-gold/50 font-bold">{item.code}</td>
                            <td class="py-2 px-3 border-r border-plm-gold/50 text-center">{item.section}</td>
                            <td class="py-2 px-3 border-r border-plm-gold/50">{item.description}</td>
                            <td class="py-2 px-3 border-r border-plm-gold/50 text-center font-bold">{item.units}</td>
                            <td class="py-2 px-3 border-r border-plm-gold/50">{item.schedule}</td>
                            <td class="py-2 px-3 border-r border-plm-gold/50 uppercase text-xs">{item.professor}</td>
                            <td class={`py-2 px-3 font-bold uppercase text-xs ${item.status === 'Enrolled' ? 'text-green-700' : 'text-gray-600'}`}>{item.status}</td>
                        </tr>
                    )) : (
                        <tr>
                            <td colspan="8" class="py-8 text-center text-gray-500 italic">
                                No schedule available for {yearParam} - {semParam}.
                            </td>
                        </tr>
                    )}
                </tbody>
            </table>
        </div>

        <div class="w-full bg-[#7F1D1D] text-white py-3 px-6 text-center font-bold shadow-md">
            Total Units {semParam === 'First Semester' && yearParam === '2025-2026' ? 'Enrolled' : 'Completed'}: <span class="text-xl ml-2">{totalUnits}</span>
        </div>

    </main>

    <!-- CONFIRM BUTTON LOGIC -->
    <script>
        const confirmBtn = document.getElementById('confirm-btn');
        const yearSelect = document.getElementById('school-year') as HTMLSelectElement;
        const semSelect = document.getElementById('semester') as HTMLSelectElement;

        if (confirmBtn && yearSelect && semSelect) {
            confirmBtn.addEventListener('click', () => {
                const selectedYear = yearSelect.value;
                const selectedSem = semSelect.value;
                
                // Reload the page with the new parameters
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('year', selectedYear);
                newUrl.searchParams.set('sem', selectedSem);
                window.location.href = newUrl.toString();
            });
        }
    </script>
</body>
</html>